window.AudioContext=window.AudioContext||window.webkitAudioContext;var detectorElem,canvasElem,waveCanvas,pitchElem,noteElem,notenum,detuneElem,pitch,pitch_calc,delay,isStarted=!1,audioContext=null,isPlaying=!1,sourceNode=null,analyser=null,theBuffer=null,DEBUGCANVAS=null,mediaStreamSource=null,Counter=0,intervalCounter=null;function error(){alert("Stream generation failed.")}function getUserMedia(e,t){try{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia(e,t,error)}catch(e){alert("getUserMedia threw exception :"+e)}}function gotStream(e){mediaStreamSource=audioContext.createMediaStreamSource(e),(sourceNode=audioContext.createBufferSource()).buffer=theBuffer,sourceNode.loop=!0,(analyser=audioContext.createAnalyser()).fftSize=2048,mediaStreamSource.connect(analyser),analyser.connect(audioContext.destination),sourceNode.start(0),isPlaying=!0,console.log("isPlaying..2",isPlaying),console.log("milliseconds",document.getElementById("milliseconds").innerHTML),console.log("milliseconds_2",document.getElementById("milliseconds").innerHTML),isLiveInput=!1,updatePitch()}function toggleLiveInput(){return console.log("isPlaying..",isPlaying),isPlaying?(null!=intervalCounter&&(clearInterval(intervalCounter),intervalCounter=null),sourceNode=null,analyser=null,isPlaying=!1,isStarted=!1,delay="00000",console.log("delay..",delay),console.log("delay....2",document.getElementById("milliseconds").innerHTML),window.cancelAnimationFrame||(window.cancelAnimationFrame=window.webkitCancelAnimationFrame),window.cancelAnimationFrame(rafID),"Get Laytency"):(document.getElementById("milliseconds").innerText=0,getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}},gotStream),"stop")}window.onload=function(){audioContext=new AudioContext,MAX_SIZE=Math.max(4,Math.floor(audioContext.sampleRate/5e3));var e=new XMLHttpRequest;e.open("GET","../sounds/whistling3.ogg",!0),e.responseType="arraybuffer",e.onload=function(){audioContext.decodeAudioData(e.response,function(e){theBuffer=e})},e.send(),detectorElem=document.getElementById("detector"),canvasElem=document.getElementById("output"),(DEBUGCANVAS=document.getElementById("waveform"))&&((waveCanvas=DEBUGCANVAS.getContext("2d")).strokeStyle="black",waveCanvas.lineWidth=1),pitchElem=document.getElementById("pitch"),noteElem=document.getElementById("note"),detuneElem=document.getElementById("detune"),detuneAmount=document.getElementById("detune_amt"),detectorElem.ondragenter=function(){return this.classList.add("droptarget"),!1},detectorElem.ondragleave=function(){return this.classList.remove("droptarget"),!1},detectorElem.ondrop=function(e){this.classList.remove("droptarget"),e.preventDefault(),theBuffer=null;var t=new FileReader;return t.onload=function(e){audioContext.decodeAudioData(e.target.result,function(e){theBuffer=e},function(){alert("error loading!")})},t.onerror=function(e){alert("Error: "+t.error)},t.readAsArrayBuffer(e.dataTransfer.files[0]),!1}};var rafID=null,tracks=null,buflen=1024,buf=new Float32Array(buflen),noteStrings=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function noteFromPitch(e){var t=Math.log(e/440)/Math.log(2)*12;return Math.round(t)+69}function frequencyFromNoteNumber(e){return 440*Math.pow(2,(e-69)/12)}function centsOffFromPitch(e,t){return Math.floor(1200*Math.log(e/frequencyFromNoteNumber(t))/Math.log(2))}var MIN_SAMPLES=0,GOOD_ENOUGH_CORRELATION=.9;function autoCorrelate(e,t){for(var n=e.length,o=Math.floor(n/2),a=-1,r=0,i=0,l=!1,u=new Array(o),d=0;d<n;d++){var c=e[d];i+=c*c}if((i=Math.sqrt(i/n))<.01)return-1;for(var s=1,m=MIN_SAMPLES;m<o;m++){var g=0;for(d=0;d<o;d++)g+=Math.abs(e[d]-e[d+m]);if(g=1-g/o,u[m]=g,g>GOOD_ENOUGH_CORRELATION&&g>s)l=!0,g>r&&(r=g,a=m);else if(l){return t/(a+8*((u[a+1]-u[a-1])/u[a]))}s=g}return r>.01?t/a:-1}function updatePitch(e){new Array;analyser.getFloatTimeDomainData(buf);var t=autoCorrelate(buf,audioContext.sampleRate);if(-1==t)detectorElem.className="vague",pitchElem.innerText="--",noteElem.innerText="-",detuneElem.className="",detuneAmount.innerText="--";else{detectorElem.className="confident",pitch_calc=(pitch=t).toFixed(0),pitchElem.innerText=Math.round(pitch);var n=noteFromPitch(pitch);noteElem.innerHTML=noteStrings[n%12],notenum=Number(n);var o=centsOffFromPitch(pitch,n);if(0==o?(detuneElem.className="",detuneAmount.innerHTML="--"):(detuneElem.className=o<0?"flat":"sharp",detuneAmount.innerHTML=Math.abs(o)),1e3==pitch_calc&&83==notenum&&21==o){console.log("pitch_calc",pitch_calc),delay=document.getElementById("milliseconds").innerHTML,isStarted=!isStarted;var a=Date.now();isStarted?intervalCounter=setInterval(function(){var e=Date.now()-a;document.getElementById("milliseconds").innerHTML=(e/1e3).toFixed(3)},100):null!=intervalCounter&&delay>.8?document.getElementById("get_laytency").innerText=toggleLiveInput():isStarted=!isStarted,console.log("delay.....!",delay)}}window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame),rafID=window.requestAnimationFrame(updatePitch)}